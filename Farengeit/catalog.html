<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ - –§–∞—Ä–µ–Ω–≥–µ–π—Ç</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container d-flex align-items-center">
        <a class="navbar-brand me-4" href="index.html">
            <img src="media/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" height="45" class="d-inline-block align-text-top">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-5">
                <li class="nav-item icon"><a class="nav-link" href="index.html"><i class="bi bi-compass"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="nav-item icon"><a class="nav-link" href="contacts.html"><i class="bi bi-telephone"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                <li class="nav-item icon"><a class="nav-link" href="forms/login.html"><i class="bi bi-box-arrow-in-right"></i> –í—Ö–æ–¥</a></li>
                <li class="nav-item icon"><a class="nav-link" href="forms/register.html"><i class="bi bi-person-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></li>
                <li><a href="tel:+74954778667">+7 (495) 477-86-67</a></li>
                <li class="nav-item me-4 email">info+10020738@farengeit-online.ru</li>
            </ul>
        </div>
    </div>
</nav>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<header class="bg-light text-center py-1">
    <div class="container">
        <h1><i class="bi bi-list"></i> –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
        <p id="headerDescription">–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</p>
    </div>
</header>

<section class="container my-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <form id="searchForm">
                <div class="input-group input-group-lg">
                    <span class="input-group-text align-items-center" id="search-icon"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." aria-label="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤">
                    <button type="submit" class="btn btn-primary">–ü–æ–∏—Å–∫</button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥ -->
<section class="container my-5">
    <h2>–ù–∞—à–∏ —Ç–æ–≤–∞—Ä—ã</h2>
    <div id="messageContainer"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="row" id="productCatalog">
        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
    </div>
</section>

<!-- –§—É—Ç–µ—Ä -->
<br>
<footer class="text-center py-3">
    <div class="container">
        <p>&copy; 2024 –ú–∞–≥–∞–∑–∏–Ω —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏ –§–∞—Ä–µ–Ω–≥–µ–π—Ç. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥ -->
<button class="cart-button" id="cartButton" onclick="goToCart()">
    <span class="cart-icon">
        üõí
        <span id="cart-count" class="cart-count">0</span> <!-- –°—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
    </span>
</button>

<script>
    function goToCart() {
        window.location.href = 'forms/cart.html';
    }

    document.addEventListener('DOMContentLoaded', async function() {
        const cartButton = document.getElementById('cartButton');
        const productCatalog = document.getElementById('productCatalog');
        const messageContainer = document.getElementById('messageContainer');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get('id');
        if (categoryId) {
            console.log('categoryId:', categoryId);
        } else {
            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
        }
        console.log('Product ID:', categoryId);
        let allServices = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function fetchProducts() {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                messageContainer.innerHTML = `
                    <div class="alert alert-warning d-flex justify-content-between align-items-center">
                        <span>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã.</span>
                        <button type="button" class="btn-close" aria-label="Close" id="closeMessage"></button>
                    </div>
                `;
                productCatalog.style.display = 'none';
                cartButton.style.display = 'none';

                document.getElementById('closeMessage').addEventListener('click', function() {
                    window.location.href = 'forms/login.html';
                });
                return;
            }

            try {
                let url = 'http://localhost:8080/protected/products';
                if (categoryId) {
                    url += `?category=${categoryId}`; // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
                }

                allServices = await response.json();
                displayServices(allServices);

                setTimeout(() => {
                    cartButton.classList.add('visible');
                }, 100);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert(error.message);
            }
        }

        updateCartButton();

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartButton() {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartCount = document.getElementById('cart-count');
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.innerText = totalItems; // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ

            if (totalItems > 0) {
                cartCount.style.display = 'inline'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –µ—Å—Ç—å
            } else {
                cartCount.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫, –µ—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
            }
        }

        document.addEventListener('DOMContentLoaded', updateCartButton);

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
        function displayServices(services) {
            productCatalog.innerHTML = '';
            if (services.length === 0) {
                messageContainer.innerHTML = `
                    <div class="alert alert-info">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>
                `;
                return;
            }


            services.forEach(service => {
                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="d-flex justify-content-center">
                                <img src="${service.image_url}" class="card-img-top" alt="${service.title}" style="max-width: 40%; height: auto; margin-top: 20px;">
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-center">${service.title}</h5>
                                <a href="product.html?id=${service.id}" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            </div>
                        </div>
                    </div>
                `;
                productCatalog.innerHTML += card;
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const searchValue = searchInput.value.toLowerCase();
            const filteredServices = allServices.filter(service =>
                service.title.toLowerCase().includes(searchValue)
            );
            displayServices(filteredServices);
        });

        fetchProducts(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    });
</script>
</body>
</html>
